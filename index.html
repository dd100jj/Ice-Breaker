<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Ice Breaker Gold - Final Stacking</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #f0f2f5);
            --card-bg: #ffffff;
            --text-main: #222222;
            --accent-orange: #ff8a65;
            --accent-blue: #4fc3f7;
            --water-color: #2196f3;
            --gray-text: #888888;
            --danger: #ff5252;
            --success: #4caf50;
        }
        body { background-color: var(--tg-bg); color: var(--text-main); font-family: 'Pretendard', sans-serif; margin: 0; padding: 15px 15px 100px 15px; display: flex; flex-direction: column; gap: 12px; overflow-x: hidden; }
        .card { background: var(--card-bg); border-radius: 15px; padding: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .res-tag { background: #fff; border: 1.5px solid #eee; padding: 5px 12px; border-radius: 20px; font-weight: bold; font-size: 12px; display: flex; align-items: center; gap: 5px; }
        .plus-btn { background: var(--water-color); color: white; border: none; width: 18px; height: 18px; border-radius: 50%; font-size: 14px; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-left: -5px; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .mine-card { align-items: center; text-align: center; gap: 6px; }
        .mining-power { font-size: 28px; font-weight: 800; }
        .harvest-btn { background: var(--accent-blue); color: white; border: none; width: 80%; padding: 15px; border-radius: 15px; font-weight: bold; font-size: 16px; margin-top: 10px; cursor: pointer; box-shadow: 0 4px 0 #02a9f4; transition: 0.1s; }
        .harvest-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #02a9f4; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 75px; background: #fff; display: flex; justify-content: space-around; align-items: center; box-shadow: 0 -2px 15px rgba(0,0,0,0.1); z-index: 999; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: var(--gray-text); flex: 1; cursor: pointer; font-size: 12px; }
        .nav-item.active { color: var(--accent-blue); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { width: 92%; background: white; border-radius: 25px; padding: 20px; box-sizing: border-box; max-height: 85vh; overflow-y: auto; }
        .history-item { padding: 12px; border: 1px solid #eee; border-radius: 12px; font-size: 11px; margin-bottom: 8px; }
    </style>
</head>
<body>

    <div style="display:flex; justify-content:space-between; align-items:center;">
        <div style="display:flex; gap:8px;">
            <div class="res-tag">ğŸ§Š <span id="ice-top-display">0</span></div>
            <div style="display:flex; align-items:center;">
                <div class="res-tag" style="color:var(--water-color);">ğŸ’§ <span id="water-top-display">0</span></div>
                <button class="plus-btn" onclick="openDeposit()">+</button>
            </div>
        </div>
        <div class="res-tag" id="lv-badge">â­ LV.1</div>
    </div>

    <div class="card">
        <div style="font-size:13px; font-weight:bold; color:var(--gray-text); margin-bottom:8px;">ğŸ§Š Ice Container (Max. 1,000)</div>
        <div style="width:100%; height:10px; background:#f0f2f5; border-radius:10px; overflow:hidden;"><div id="ice-gauge-bar" style="width:0%; height:100%; background:var(--accent-blue); transition:width 0.3s;"></div></div>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
            <div class="mining-power" id="balance">0</div>
            <div style="color:var(--accent-orange); font-weight:bold; font-size:13px;" id="ice-to-usdt">0.00 USDT</div>
        </div>
    </div>

    <div class="card mine-card">
        <lottie-player src="https://lottie.host/872a8b1d-7fb8-4e06-9566-575c112ceb60/4RHshKiCu8.json" background="transparent" speed="1" style="width: 150px; height: 150px;" loop autoplay></lottie-player>
        <div class="mining-power" id="mining-power">+ 0.00000</div>
        <div id="speed-display" style="color:var(--accent-orange); font-weight:bold; font-size:14px;">+ 0.00005 / sec</div>
        <button class="harvest-btn" onclick="mineClick()">ğŸ§Š HARVEST ICE</button>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="location.reload()">ğŸ <span>Home</span></div>
        <div class="nav-item" onclick="openShop()">ğŸ›’<span>Shop</span></div>
        <div class="nav-item" onclick="openWallet()">ğŸ’¼<span>Wallet</span></div>
    </nav>

    <div id="shop-modal" class="modal"><div class="modal-content">
        <h3>Water Shop ğŸ’§</h3>
        <div id="shop-list"></div>
        <button onclick="closeModal('shop-modal')" style="width:100%; padding:10px; margin-top:10px; border:none; border-radius:10px;">Close</button>
    </div></div>

    <div id="wallet-modal" class="modal"><div class="modal-content">
        <h3>History</h3>
        <div id="history-container"></div>
        <button onclick="closeModal('wallet-modal')" style="width:100%; padding:10px; margin-top:10px; border:none; border-radius:10px;">Close</button>
    </div></div>

    <script>
        const tg = window.Telegram.WebApp;
        const firebaseConfig = { /* ì‚¬ìš©ìë‹˜ì˜ ì„¤ì •ê°’ ìœ ì§€ */ };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const USER_ID = tg.initDataUnsafe?.user?.id?.toString() || "guest_user";

        // ì•„ì´í…œ ìƒìˆ˜ ì •ì˜
        const ITEM_DEFS = {
            'pickaxe': { name: 'Iron Pickaxe', speed: 0.0001, hours: 24, price: 500 },
            'gear': { name: 'Silver Gear', speed: 0.0005, hours: 24, price: 1500 },
            'drill': { name: 'Diamond Drill', speed: 0.0020, hours: 48, price: 5000 },
            'spray': { name: 'Cooling Spray', speed: 2, hours: 12, price: 1500, isMultiplier: true }
        };

        // ì´ˆê¸° ë°ì´í„° êµ¬ì¡° (activeItemsëŠ” ì´ì œ ë°°ì—´ì…ë‹ˆë‹¤)
        let userData = { shards: 0, water: 0, power: 0, level: 1, activeItems: [], lastUpdate: Date.now() };

        async function loadData() {
            const doc = await db.collection("users").doc(USER_ID).get();
            if (doc.exists) {
                const data = doc.data();
                const now = Date.now();
                
                // [í•µì‹¬] ê°œë³„ ì•„ì´í…œ ë§Œë£Œ ì²´í¬ ë° ë‚´ì—­ ê¸°ë¡
                let aliveItems = [];
                for (let item of (data.activeItems || [])) {
                    if (now < item.expiry) {
                        aliveItems.push(item);
                    } else {
                        const effect = item.isMultiplier ? "x2 Boost" : `-${item.value}/s`;
                        await addTransaction("ITEM_EXPIRED", "0 ICE", "completed", `${item.name} ë§Œë£Œ (${effect})`);
                    }
                }

                const lastUpdate = data.lastUpdate || now;
                const offlineSec = (now - lastUpdate) / 1000;
                
                // í˜„ì¬ ì¤‘ì²©ëœ ì†ë„ ê³„ì‚°
                const currentSpeed = calculateSpeed(aliveItems, data.level);
                
                userData = { ...userData, ...data, activeItems: aliveItems };
                userData.power = Math.min(1000, (data.power || 0) + (offlineSec * currentSpeed));
                userData.lastUpdate = now;
                await saveData();
            }
            updateUI();
        }

        // [ì¤‘ìš”] ëª¨ë“  ì•„ì´í…œì˜ ì†ë„ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ í•©ì‚°í•˜ëŠ” í•¨ìˆ˜
        function calculateSpeed(items, level) {
            const levelBonus = [0, 0.00001, 0.00002, 0.00003, 0.00005, 0.00008, 0.00012, 0.00020, 0.00035, 0.00060];
            let baseSpeed = 0.00005 + (levelBonus[level-1] || 0);
            let addedSpeed = 0;
            let multiplier = 1;

            items.forEach(item => {
                if (item.isMultiplier) multiplier *= item.value;
                else addedSpeed += item.value;
            });

            return (baseSpeed + addedSpeed) * multiplier;
        }

        async function buyItem(id) {
            const def = ITEM_DEFS[id];
            if (userData.water < def.price) return tg.showAlert("Need Water!");

            const now = Date.now();
            const expiry = now + (def.hours * 3600 * 1000);
            
            // êµ¬ë§¤í•œ ì‹œì ì˜ ê³ ìœ  ì •ë³´ë¥¼ ë°°ì—´ì— ì¶”ê°€ (ê°œë³„ íƒ€ì´ë¨¸ ë³´ì¥)
            const newItem = {
                id: id + "_" + now,
                name: def.name,
                value: def.speed,
                expiry: expiry,
                isMultiplier: def.isMultiplier || false
            };

            userData.water -= def.price;
            userData.activeItems.push(newItem);

            const effect = def.isMultiplier ? "x2 Boost" : `+${def.speed}/s`;
            await addTransaction("ITEM_ACTIVATE", def.price + " WATER", "completed", `${def.name} í™œì„±í™” (${effect})`);
            
            await saveData();
            updateUI();
            tg.showAlert(`${def.name} êµ¬ë§¤ ì™„ë£Œ! ì†ë„ ${effect}ê°€ í•©ì‚°ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            closeModal('shop-modal');
        }

        function updateUI() {
            const currentSpeed = calculateSpeed(userData.activeItems, userData.level);
            document.getElementById('balance').innerText = userData.shards.toLocaleString(undefined, {minimumFractionDigits: 5});
            document.getElementById('ice-top-display').innerText = Math.floor(userData.shards).toLocaleString();
            document.getElementById('water-top-display').innerText = userData.water.toLocaleString();
            document.getElementById('ice-to-usdt').innerText = (userData.shards / 1400).toFixed(2) + " USDT";
            document.getElementById('mining-power').innerText = "+ " + userData.power.toFixed(5);
            document.getElementById('speed-display').innerText = "+ " + currentSpeed.toFixed(5) + " / sec";
            document.getElementById('ice-gauge-bar').style.width = (userData.power / 10) + "%";
            document.getElementById('lv-badge').innerText = `â­ LV.${userData.level}`;
        }

        async function addTransaction(type, amount, status, detail) {
            await db.collection("transactions").add({
                userId: USER_ID, type, amount, status, detail, timestamp: Date.now()
            });
        }

        function renderShop() {
            const list = document.getElementById('shop-list');
            list.innerHTML = "";
            Object.entries(ITEM_DEFS).forEach(([id, def]) => {
                const div = document.createElement('div');
                div.style = "display:flex; justify-content:space-between; align-items:center; padding:12px; border-bottom:1px solid #eee;";
                div.innerHTML = `
                    <div><b>${def.name}</b><br><small>${def.isMultiplier ? 'Speed x2' : '+'+def.speed+'/s'} (${def.hours}h)</small></div>
                    <button style="background:var(--water-color); color:white; border:none; padding:8px 12px; border-radius:8px; font-weight:bold;" onclick="buyItem('${id}')">ğŸ’§ ${def.price}</button>
                `;
                list.appendChild(div);
            });
        }

        async function openWallet() {
            document.getElementById('wallet-modal').style.display = 'flex';
            const container = document.getElementById('history-container');
            container.innerHTML = "Loading...";
            const snap = await db.collection("transactions").where("userId", "==", USER_ID).orderBy("timestamp", "desc").limit(15).get();
            container.innerHTML = "";
            snap.forEach(doc => {
                const d = doc.data();
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `<strong>${d.type}</strong> <span style="float:right">${d.amount}</span><br><small>${d.detail}</small><br><small style="color:#999">${new Date(d.timestamp).toLocaleString()}</small>`;
                container.appendChild(div);
            });
        }

        async function saveData() { userData.lastUpdate = Date.now(); await db.collection("users").doc(USER_ID).set(userData, {merge:true}); }
        function openShop() { renderShop(); document.getElementById('shop-modal').style.display='flex'; }
        function closeModal(id) { document.getElementById(id).style.display='none'; }
        function mineClick() { if(userData.power >= 0.005) { userData.shards += userData.power; userData.power = 0; updateUI(); saveData(); } }

        setInterval(() => {
            const speed = calculateSpeed(userData.activeItems, userData.level);
            if(userData.power < 1000) { userData.power += speed; updateUI(); }
        }, 1000);

        loadData();
    </script>
</body>
</html>
